Summary,Issue Type,Description,Story Points,Priority,Labels
"Sprint 4: Tierlists Personales",Epic,"Funcionalidad principal: tierlists por usuario y aÃ±o con relaciones @OneToMany, cascade delete, campos denormalizados y prevenciÃ³n del problema N+1.",,High,epic
"TIER-01: Crear entidades Tierlist y TierlistEntry",Story,"## ðŸŽ¯ Objetivo
Crear las entidades Tierlist y TierlistEntry con relaciÃ³n @OneToMany y campos denormalizados.

---

## ðŸ“‹ EspecificaciÃ³n funcional

**Entidad Tierlist:**
- Hereda de BaseEntity
- user: User (@ManyToOne LAZY)
- anio: Integer
- entries: List<TierlistEntry> (@OneToMany, cascade ALL, orphanRemoval)
- Constraint UNIQUE: (user_id, anio) - Un usuario solo puede tener una tierlist por aÃ±o

**Entidad TierlistEntry:**
- Hereda de BaseEntity
- tierlist: Tierlist (@ManyToOne LAZY)
- game: Game (@ManyToOne LAZY)
- rating: Integer (1-10)
- anioJugado: Integer (aÃ±o en que se jugÃ³)
- **Campos denormalizados (copiados del Game):**
  - gameNombre: String
  - gamePlataforma: String
  - gameCategoria: String
  - gameDescripcion: String
  - gameAnioLanzamiento: Integer
- Constraint UNIQUE: (tierlist_id, game_id) - Un juego solo puede estar una vez por tierlist

**Â¿Por quÃ© denormalizar?**
- Permite filtrar entries sin hacer JOIN a Game
- Mejor rendimiento en listados y bÃºsquedas
- PatrÃ³n comÃºn en aplicaciones reales con muchos datos
- Trade-off: duplicaciÃ³n de datos vs velocidad de lectura

**Repositories:**
- TierlistRepository con mÃ©todo findByUserIdAndAnio()
- TierlistEntryRepository con existsByTierlistIdAndGameId()

---

## âœ… Criterios de aceptaciÃ³n

- [ ] Entidad Tierlist con @OneToMany cascade ALL y orphanRemoval
- [ ] Entidad TierlistEntry con campos denormalizados
- [ ] Constraint UNIQUE en (user_id, anio) para Tierlist
- [ ] Constraint UNIQUE en (tierlist_id, game_id) para Entry
- [ ] MÃ©todos helper en Tierlist: addEntry(), removeEntry()
- [ ] Constructor en TierlistEntry que copia datos del Game

---

## ðŸ§ª Testing requerido

**Tests de repositorio:**
- shouldFindTierlistByUserAndAnio
- shouldCascadeDeleteEntries (al eliminar tierlist, se eliminan entries)

---

## ðŸ”— Referencias

| Concepto | Documento |
|----------|-----------|
| @OneToMany cascade | Concepto JPA |
| orphanRemoval | Elimina entries huÃ©rfanas automÃ¡ticamente |

---

## ðŸ’¡ Pistas

1. @OneToMany(mappedBy = ""tierlist"", cascade = CascadeType.ALL, orphanRemoval = true)
2. El constructor de TierlistEntry recibe Game y copia sus datos
3. Los mÃ©todos helper mantienen la relaciÃ³n bidireccional sincronizada
4. @OrderBy(""rating DESC"") ordena entries por rating automÃ¡ticamente

---

## ðŸ“– CÃ³digo de referencia

Ver: SPRINT-4-soluciones.md â†’ TIER-01",5,High,"backend,entity,sprint4"
"TIER-02: POST /api/users/{userId}/tierlists - Crear tierlist",Story,"## ðŸŽ¯ Objetivo
Implementar endpoint para crear una tierlist para un usuario y aÃ±o especÃ­fico.

---

## ðŸ“‹ EspecificaciÃ³n funcional

| MÃ©todo | Endpoint | Request Body | Response |
|--------|----------|--------------|----------|
| POST | /api/users/{userId}/tierlists | CreateTierlistRequest | 201 + TierlistSummary |

**CreateTierlistRequest (Record):**
- anio: Integer (@NotNull, @Min=2000, @Max=2030)

**TierlistSummary (Record):**
- id: Long
- anio: Integer
- totalJuegos: Integer (inicialmente 0)
- fechaCreacion: LocalDateTime

**Reglas de negocio:**
- El usuario debe existir
- No puede existir otra tierlist del mismo usuario para ese aÃ±o

---

## âœ… Criterios de aceptaciÃ³n

| Caso | Input | Output |
|------|-------|--------|
| Crear vÃ¡lido | POST /api/users/1/tierlists {anio: 2024} | 201 + TierlistSummary |
| Usuario no existe | POST /api/users/999/tierlists | 404 |
| AÃ±o duplicado | POST con aÃ±o que ya existe para ese usuario | 409 |

---

## ðŸ§ª Testing requerido

**Tests unitarios (TierlistServiceTest):**
- shouldCreateTierlist_WhenValid
- shouldThrowNotFound_WhenUserDoesNotExist
- shouldThrowDuplicate_WhenTierlistAlreadyExistsForYear

**Tests de controller (TierlistControllerTest):**
- shouldReturn201_WhenTierlistCreated
- shouldReturn404_WhenUserNotFound
- shouldReturn409_WhenDuplicateYear

---

## ðŸ’¡ Pistas

1. El controller usa @PathVariable para userId
2. Verificar primero que el usuario existe
3. Verificar que no existe tierlist para ese usuario+aÃ±o
4. totalJuegos es entries.size() o un campo calculado

---

## ðŸ“– CÃ³digo de referencia

Ver: SPRINT-4-soluciones.md â†’ TIER-02",3,High,"backend,api,sprint4"
"TIER-03: GET /api/users/{userId}/tierlists - Listar tierlists",Story,"## ðŸŽ¯ Objetivo
Implementar endpoint para listar las tierlists de un usuario.

---

## ðŸ“‹ EspecificaciÃ³n funcional

| MÃ©todo | Endpoint | Response |
|--------|----------|----------|
| GET | /api/users/{userId}/tierlists | 200 + List<TierlistSummary> |

**Comportamiento:**
- Devuelve todas las tierlists del usuario ordenadas por aÃ±o DESC
- Incluye el conteo de juegos (totalJuegos) en cada tierlist
- Si el usuario no existe, devuelve 404
- Si no tiene tierlists, devuelve lista vacÃ­a

---

## âœ… Criterios de aceptaciÃ³n

- [ ] GET /api/users/1/tierlists devuelve tierlists ordenadas por aÃ±o DESC
- [ ] Cada TierlistSummary incluye totalJuegos correcto
- [ ] GET /api/users/999/tierlists devuelve 404 si usuario no existe
- [ ] GET con usuario sin tierlists devuelve lista vacÃ­a []

---

## ðŸ§ª Testing requerido

**Tests unitarios (TierlistServiceTest):**
- shouldReturnTierlistsOrderedByAnioDesc
- shouldReturnEmptyList_WhenUserHasNoTierlists
- shouldThrowNotFound_WhenUserDoesNotExist

---

## ðŸ’¡ Pistas

1. Usar findByUserIdOrderByAnioDesc() en el repository
2. El conteo puede ser entries.size() o una query con COUNT
3. Verificar existencia del usuario antes de buscar tierlists

---

## ðŸ“– CÃ³digo de referencia

Ver: SPRINT-4-soluciones.md â†’ TIER-03",3,High,"backend,api,sprint4"
"TIER-04: GET /api/users/{userId}/tierlists/{anio} - Detalle con entries",Story,"## ðŸŽ¯ Objetivo
Implementar endpoint para obtener una tierlist con todas sus entries.

---

## ðŸ“‹ EspecificaciÃ³n funcional

| MÃ©todo | Endpoint | Response |
|--------|----------|----------|
| GET | /api/users/{userId}/tierlists/{anio} | 200 + TierlistDetail |

**TierlistDetail (Record):**
- id: Long
- anio: Integer
- userId: Long
- userName: String
- entries: List<TierlistEntryResponse>
- fechaCreacion: LocalDateTime

**TierlistEntryResponse (Record):**
- id: Long
- gameId: Long
- gameNombre: String (del campo denormalizado)
- gamePlataforma: String
- gameCategoria: String
- rating: Integer
- anioJugado: Integer
- tier: String (calculado: S/A/B/C/D segÃºn rating)

**CÃ¡lculo de Tier:**
- 10-9: S
- 8-7: A
- 6-5: B
- 4-3: C
- 2-1: D

**Problema N+1:**
Si no se optimiza, al acceder a entries y luego a cada game, se hacen N+1 queries.
Usar @EntityGraph o JOIN FETCH para cargar todo en una query.

---

## âœ… Criterios de aceptaciÃ³n

- [ ] GET devuelve tierlist con todas sus entries
- [ ] Entries ordenadas por rating DESC
- [ ] Cada entry incluye el tier calculado (S/A/B/C/D)
- [ ] Solo se ejecuta 1 query (verificar en logs)
- [ ] GET con tierlist inexistente devuelve 404

---

## ðŸ§ª Testing requerido

**Tests unitarios (TierlistServiceTest):**
- shouldReturnTierlistWithEntries
- shouldCalculateTierCorrectly
- shouldThrowNotFound_WhenTierlistDoesNotExist

---

## ðŸ”— Referencias

| Concepto | Documento |
|----------|-----------|
| Switch expressions | JAVA8-A-JAVA17.md - SecciÃ³n 4 |

---

## ðŸ’¡ Pistas

1. @EntityGraph(attributePaths = {""entries""}) en el repository
2. O usar @Query con JOIN FETCH
3. El tier se calcula en el mapper con switch expression
4. Los datos del juego vienen de los campos denormalizados, no del Game

---

## ðŸ“– CÃ³digo de referencia

Ver: SPRINT-4-soluciones.md â†’ TIER-04",3,High,"backend,api,sprint4"
"TIER-05: POST /api/users/{userId}/tierlists/{anio}/entries - AÃ±adir juego",Story,"## ðŸŽ¯ Objetivo
Implementar endpoint para aÃ±adir un juego a una tierlist.

---

## ðŸ“‹ EspecificaciÃ³n funcional

| MÃ©todo | Endpoint | Request Body | Response |
|--------|----------|--------------|----------|
| POST | /api/users/{userId}/tierlists/{anio}/entries | CreateEntryRequest | 201 + TierlistEntryResponse |

**CreateEntryRequest (Record):**
- gameId: Long (@NotNull)
- rating: Integer (@NotNull, @Min=1, @Max=10)
- anioJugado: Integer (@NotNull, @Min=1970)

**Comportamiento especial:**
- Si la tierlist no existe para ese aÃ±o, **crearla automÃ¡ticamente**
- Copiar datos del juego a los campos denormalizados de la entry

**Reglas de negocio:**
- El usuario debe existir
- El juego debe existir
- El juego no puede estar ya en la tierlist

---

## âœ… Criterios de aceptaciÃ³n

| Caso | Input | Output |
|------|-------|--------|
| AÃ±adir a tierlist existente | POST con tierlist que existe | 201 + Entry |
| AÃ±adir creando tierlist | POST con aÃ±o sin tierlist | 201 + Entry (crea tierlist) |
| Usuario no existe | userId invÃ¡lido | 404 |
| Juego no existe | gameId invÃ¡lido | 404 |
| Juego duplicado | gameId ya en tierlist | 409 |

---

## ðŸ§ª Testing requerido

**Tests unitarios (TierlistServiceTest):**
- shouldAddEntry_WhenTierlistExists
- shouldCreateTierlistAndAddEntry_WhenTierlistDoesNotExist
- shouldCopyGameDataToEntry
- shouldThrowDuplicate_WhenGameAlreadyInTierlist

---

## ðŸ’¡ Pistas

1. findByUserIdAndAnio() puede devolver Optional.empty()
2. Si no existe, crear la tierlist primero
3. El constructor de TierlistEntry copia todos los datos del Game
4. Usar el mÃ©todo helper tierlist.addEntry() para mantener sincronizaciÃ³n

---

## ðŸ“– CÃ³digo de referencia

Ver: SPRINT-4-soluciones.md â†’ TIER-05",5,High,"backend,api,sprint4"
"TIER-06: PUT/DELETE entries",Story,"## ðŸŽ¯ Objetivo
Implementar endpoints para actualizar y eliminar entries de una tierlist.

---

## ðŸ“‹ EspecificaciÃ³n funcional

| MÃ©todo | Endpoint | Request Body | Response |
|--------|----------|--------------|----------|
| PUT | /api/users/{userId}/tierlists/{anio}/entries/{entryId} | UpdateEntryRequest | 200 + TierlistEntryResponse |
| DELETE | /api/users/{userId}/tierlists/{anio}/entries/{entryId} | - | 204 |

**UpdateEntryRequest (Record):**
- rating: Integer (@NotNull, @Min=1, @Max=10)
- anioJugado: Integer (@NotNull, @Min=1970)

**Nota:** No se puede cambiar el juego, solo rating y aÃ±o jugado.

---

## âœ… Criterios de aceptaciÃ³n

**PUT:**
- [ ] Actualiza rating y anioJugado
- [ ] Devuelve 404 si entry no existe
- [ ] El tier se recalcula con el nuevo rating

**DELETE:**
- [ ] Elimina la entry
- [ ] Devuelve 204
- [ ] Devuelve 404 si entry no existe

---

## ðŸ§ª Testing requerido

**Tests unitarios:**
- shouldUpdateEntry_WhenExists
- shouldDeleteEntry_WhenExists
- shouldThrowNotFound_WhenEntryDoesNotExist

**Tests de controller:**
- shouldReturn200_WhenEntryUpdated
- shouldReturn204_WhenEntryDeleted
- shouldReturn404_WhenEntryNotFound

---

## ðŸ’¡ Pistas

1. Verificar que la entry pertenece a la tierlist correcta
2. Para delete, usar tierlist.removeEntry() o directamente el repository
3. orphanRemoval=true deberÃ­a eliminar la entry al quitarla de la lista

---

## ðŸ“– CÃ³digo de referencia

Ver: SPRINT-4-soluciones.md â†’ TIER-06",3,Medium,"backend,api,sprint4"
"TIER-07: Verificar juego en uso antes de eliminar",Story,"## ðŸŽ¯ Objetivo
Modificar GameService.delete() para que no permita eliminar juegos que estÃ©n en uso en alguna tierlist.

---

## ðŸ“‹ EspecificaciÃ³n funcional

**Comportamiento actual:** DELETE /api/games/{id} elimina el juego

**Comportamiento nuevo:** 
- Si el juego estÃ¡ en alguna TierlistEntry, devolver 409 Conflict
- Si no estÃ¡ en uso, eliminarlo normalmente

**Nueva excepciÃ³n:**
- EntityInUseException: Cuando se intenta eliminar algo que estÃ¡ referenciado

---

## âœ… Criterios de aceptaciÃ³n

- [ ] DELETE /api/games/{id} con juego en uso devuelve 409
- [ ] DELETE /api/games/{id} sin uso devuelve 204
- [ ] El mensaje de error indica que el juego estÃ¡ en uso

---

## ðŸ§ª Testing requerido

**Tests unitarios (GameServiceTest):**
- shouldThrowEntityInUse_WhenGameIsInTierlist
- shouldDeleteGame_WhenNotInUse

---

## ðŸ’¡ Pistas

1. AÃ±adir existsByGameId(Long gameId) a TierlistEntryRepository
2. Crear EntityInUseException extends RuntimeException
3. AÃ±adir handler en GlobalExceptionHandler que devuelva 409
4. Modificar GameService.delete() para verificar antes de eliminar

---

## ðŸ“– CÃ³digo de referencia

Ver: SPRINT-4-soluciones.md â†’ TIER-07",2,Medium,"backend,api,sprint4"
